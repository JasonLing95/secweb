{% extends "base.html" %} {% block styles %} {{ super() }}
<style>
  /* Style for the search dropdown */
  .search-container {
    position: relative;
  }
  #company-search-results {
    position: absolute;
    top: 100%;
    left: 0;
    z-index: 1000;
    width: 100%;
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid rgba(0, 0, 0, 0.15);
    border-top: none;
    border-radius: 0 0 0.375rem 0.375rem;
  }
</style>
{% endblock %} {% block content %}
<h1>Latest 13F Filings</h1>

{% if pagination and pagination.total > 0 %}
<div class="row mb-3 align-items-center">
  <div class="col-md-6 mb-2 mb-md-0 search-container">
    <input
      class="form-control"
      type="search"
      id="company-search-input"
      placeholder="Search Company/CIK to jump to page..."
      aria-label="Search"
      autocomplete="off"
    />
    <div class="dropdown-menu" id="company-search-results"></div>
  </div>
  <div class="col-md-6 text-md-end">
    <p class="text-muted mb-0">
      Showing {{ pagination.offset + 1 }} to {{ pagination.offset +
      filings|length }} of {{ pagination.total }} filings
    </p>
  </div>
</div>
{% endif %} {% if filings and filings|length > 0 %}
<div class="table-responsive">
  <table class="table table-striped table-hover table-fixed-layout">
    <colgroup>
      <col style="width: 30%" />
      <col style="width: 10%" />
      <col style="width: 10%" />
      <col style="width: 15%" />
      <col style="width: 10%" />
      <col style="width: 10%" />
      <col style="width: 15%" />
    </colgroup>
    <thead class="table-light">
      <tr>
        {% set sort_columns = { 'company_name': 'Company Name', 'cik_number':
        'CIK', 'form_type': 'Form Type', 'accession_number': 'Accession Number',
        'filing_date': 'Filing Date', 'period_of_report': 'Reporting Period',
        'created_at': 'Created At' } %} {% for key, value in
        sort_columns.items() %}
        <th>
          {% set new_order = 'desc' if current_sort_by == key and
          current_sort_order == 'asc' else 'asc' %}
          <a
            href="{{ url_for('index', page=current_page, per_page=per_page, sort_by=key, sort_order=new_order) }}"
            class="text-decoration-none text-dark fw-bold"
          >
            {{ value }} {% if current_sort_by == key %} {% if current_sort_order
            == 'asc' %}
            <span class="sort-indicator">▲</span>
            {% else %}
            <span class="sort-indicator">▼</span>
            {% endif %} {% endif %}
          </a>
        </th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for filing in filings %}
      <tr>
        <td>
          {% if filing.company_name %}
          <a
            href="{{ url_for('latest_company_quarters_comparison', cik=filing.cik_number) }}"
          >
            {{ filing.company_name }}
          </a>
          {% else %}
          <span class="text-muted">Unknown Company</span>
          {% endif %}
        </td>
        <td>{{ filing.cik_number }}</td>
        <td>
          <span class="badge bg-primary">{{ filing.form_type }}</span>
        </td>
        <td>
          <a
            href="{{ url_for('filing_by_accession', accession_number=filing.accession_number) }}"
          >
            {{ filing.accession_number }}
          </a>
        </td>
        <td>{{ filing.filing_date }}</td>
        <td>{{ filing.period_of_report }}</td>
        <td>{{ filing.created_at | human_date }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% if pagination and pagination.total > per_page %}
<nav aria-label="Filings pagination">
  <ul class="pagination justify-content-center">
    <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
      <a
        class="page-link"
        href="{{ url_for('index', page=current_page-1, per_page=per_page, sort_by=current_sort_by, sort_order=current_sort_order) }}"
        aria-label="Previous"
      >
        <span aria-hidden="true">&laquo;</span>
      </a>
    </li>

    {% set total_pages = (pagination.total + per_page - 1) // per_page %} {% set
    start_page = max(1, current_page - 2) %} {% set end_page = min(total_pages,
    start_page + 4) %} {% for p in range(start_page, end_page + 1) %}
    <li class="page-item {% if p == current_page %}active{% endif %}">
      <a
        class="page-link"
        href="{{ url_for('index', page=p, per_page=per_page, sort_by=current_sort_by, sort_order=current_sort_order) }}"
      >
        {{ p }}
      </a>
    </li>
    {% endfor %}

    <li class="page-item {% if not pagination.has_more %}disabled{% endif %}">
      <a
        class="page-link"
        href="{{ url_for('index', page=current_page+1, per_page=per_page, sort_by=current_sort_by, sort_order=current_sort_order) }}"
        aria-label="Next"
      >
        <span aria-hidden="true">&raquo;</span>
      </a>
    </li>
  </ul>
</nav>

<div class="d-flex justify-content-center mt-3">
  <div class="btn-group" role="group">
    <span class="me-2 align-self-center">Items per page:</span>
    {% for count in [10, 25, 50, 100] %}
    <a
      href="{{ url_for('index', page=1, per_page=count, sort_by=current_sort_by, sort_order=current_sort_order) }}"
      class="btn btn-outline-primary {% if per_page == count %}active{% endif %}"
    >
      {{ count }}
    </a>
    {% endfor %}
  </div>
</div>
{% endif %} {% else %}
<div class="alert alert-info">
  <i class="fas fa-info-circle me-2"></i>
  No filings found. {% if pagination and pagination.total == 0 %} There are no
  filings in the database. {% else %} Try adjusting your search criteria. {%
  endif %}
</div>
{% endif %} {% endblock %} {% block scripts %} {{ super() }}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("company-search-input");
    const searchResults = document.getElementById("company-search-results");

    const API_HOST = "{{ api_url }}";
    let debounceTimer;

    function debounce(func, delay) {
      return function () {
        const context = this;
        const args = arguments;
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => func.apply(context, args), delay);
      };
    }

    async function fetchResults() {
      const query = searchInput.value;
      if (query.length < 2) {
        searchResults.innerHTML = "";
        searchResults.classList.remove("show");
        return;
      }

      try {
        const response = await fetch(
          `${API_HOST}/api/search/companies?q=${encodeURIComponent(query)}`
        );
        if (!response.ok) throw new Error("Network error");

        const companies = await response.json();
        searchResults.innerHTML = ""; // Clear old

        if (companies.length > 0) {
          companies.forEach((company) => {
            const link = document.createElement("a");
            // This link now goes to the company detail page
            link.href = `/company/latest/${company.cik}`;
            link.className = "dropdown-item";
            link.innerHTML = `<strong>${company.name}</strong> <small class.text-muted">(${company.cik})</small>`;
            searchResults.appendChild(link);
          });
        } else {
          const noResult = document.createElement("span");
          noResult.className = "dropdown-item text-muted";
          noResult.textContent = "No companies found.";
          searchResults.appendChild(noResult);
        }
        searchResults.classList.add("show");
      } catch (error) {
        console.error("Error fetching company search:", error);
        searchResults.innerHTML =
          '<span class="dropdown-item text-danger">Error loading results.</span>';
        searchResults.classList.add("show");
      }
    }

    searchInput.addEventListener("input", debounce(fetchResults, 300));

    // Hide results when clicking outside
    document.addEventListener("click", function (e) {
      if (e.target.closest(".search-container") === null) {
        searchResults.classList.remove("show");
      }
    });

    // Re-show on focus if there is text
    searchInput.addEventListener("focus", function () {
      if (searchInput.value.length >= 2) {
        fetchResults();
      }
    });
  });
</script>
{% endblock %}
