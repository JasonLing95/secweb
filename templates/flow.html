{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Institutional Flow Analysis</h1>
        <div>
            <span class="badge bg-secondary p-2">CUSIP: {{ cusip }}</span>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Net Buying vs. Selling (Shares)</h5>
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-primary active" onclick="updateChartRange(2)">2 Years</button>
                <button type="button" class="btn btn-outline-primary" onclick="updateChartRange(5)">5 Years</button>
                <button type="button" class="btn btn-outline-primary" onclick="updateChartRange(8)">8 Years</button>
                <button type="button" class="btn btn-outline-primary" onclick="updateChartRange(null)">All Time</button>
            </div>
        </div>
        <div class="card-body">
            <div style="position: relative; height: 60vh; width: 100%;">
                
                <canvas id="flowChart"></canvas>

                <div id="loading" class="d-flex justify-content-center align-items-center" 
                     style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255,255,255,0.75); z-index: 10; backdrop-filter: blur(1px);">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted fw-bold">Fetching historical data...</p>
                    </div>
                </div>

                <div id="error-message" class="d-none d-flex justify-content-center align-items-center" 
                     style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255,255,255,0.9); z-index: 20;">
                    <div class="alert alert-danger shadow-sm">
                        <i class="fas fa-exclamation-circle me-2"></i> <span id="error-text"></span>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const CUSIP = "{{ cusip }}";
    const API_HOST = "{{ api_url }}";
    let flowChart = null;

    document.addEventListener('DOMContentLoaded', () => {
        fetchData(2);
    });

    function updateChartRange(years) {
        const clickedBtn = event.target.closest('button');
        document.querySelectorAll('.btn-group button').forEach(btn => btn.classList.remove('active'));
        clickedBtn.classList.add('active');
        fetchData(years);
    }

    async function fetchData(years = null) {
        const loading = document.getElementById('loading');
        const errorDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        
        // Show loader overlay
        loading.classList.remove('d-none');
        errorDiv.classList.add('d-none');
        
        try {
            let url = `${API_HOST}/api/v1/flow/${CUSIP}`;
            if (years) {
                url += `?years=${years}`;
            }

            const response = await fetch(url);
            if (!response.ok) throw new Error("Failed to fetch data");
            
            const data = await response.json();
            
            // Hide loader
            loading.classList.add('d-none');

            if (!data.history || data.history.length === 0) {
                if (flowChart) {
                    flowChart.destroy();
                    flowChart = null;
                }
                errorText.textContent = "No historical flow data found for this CUSIP.";
                errorDiv.classList.remove('d-none');
                return;
            }

            renderChart(data.history);

        } catch (err) {
            loading.classList.add('d-none');
            errorText.textContent = err.message;
            errorDiv.classList.remove('d-none');
        }
    }

    function renderChart(history) {
        const ctx = document.getElementById('flowChart').getContext('2d');
        
        const labels = history.map(item => item.date);
        const buyingData = history.map(item => item.gross_buying);
        const sellingData = history.map(item => -item.gross_selling); 
        const netData = history.map(item => item.net_change);

        if (flowChart) {
            flowChart.destroy();
        }

        flowChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Net Change',
                        data: netData,
                        type: 'line',
                        borderColor: '#0d6efd',
                        borderWidth: 2,
                        tension: 0.3,
                        pointRadius: 3,
                        order: 0
                    },
                    {
                        label: 'Gross Buying',
                        data: buyingData,
                        backgroundColor: 'rgba(25, 135, 84, 0.6)',
                        borderColor: 'rgba(25, 135, 84, 1)',
                        borderWidth: 1,
                        order: 1
                    },
                    {
                        label: 'Gross Selling',
                        data: sellingData,
                        backgroundColor: 'rgba(220, 53, 69, 0.6)',
                        borderColor: 'rgba(220, 53, 69, 1)',
                        borderWidth: 1,
                        order: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        grid: { display: false }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Shares'
                        },
                        ticks: {
                            callback: function(value) {
                                if (Math.abs(value) >= 1000000) return (value/1000000).toFixed(1) + 'M';
                                if (Math.abs(value) >= 1000) return (value/1000).toFixed(0) + 'K';
                                return value;
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }

                                const rawValue = context.raw;

                                if (context.dataset.label === 'Net Change') {
                                    const formatted = new Intl.NumberFormat('en-US').format(rawValue);
                                    if (rawValue > 0) {
                                        label += '+' + formatted;
                                    } else {
                                        label += formatted;
                                    }
                                } else {
                                    label += new Intl.NumberFormat('en-US').format(Math.abs(rawValue));
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}