{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="mb-0">Daily Institutional Flow</h1>
            <p class="text-muted mb-0">Analyzing filing dates to show market impact</p>
        </div>
        <div>
            <span id="identifier-badge" class="badge bg-secondary p-2 fs-6">{{ cusip }}</span>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="fas fa-table me-2"></i>Daily Activity Log</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                <table class="table table-striped table-hover align-middle mb-0" id="flow-table">
                    <thead class="table-light sticky-top" style="z-index: 1020;">
                        <tr>
                            <th class="ps-4">Date</th>
                            <th class="text-end">Net Change</th>
                            <th class="text-end text-success">Gross Buying</th>
                            <th class="text-end text-danger pe-4">Gross Selling</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <tr id="loading-indicator">
                            <td colspan="4" class="text-center py-5 text-muted">
                                <div class="spinner-border text-primary mb-2" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <div>Loading flow data...</div>
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="4" class="text-center p-3 bg-light">
                                <button id="btn-load-more" class="btn btn-outline-primary btn-sm w-100" onclick="loadMoreHistory()">
                                    <i class="fas fa-clock me-1"></i> Load Previous 7 Days
                                </button>
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-5">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Flow Visualization</h5>
        </div>
        <div class="card-body">
            <div id="chart-loading" class="d-flex justify-content-center align-items-center" style="height: 50vh; position: absolute; width: 100%; z-index: 5;">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            
            <div style="position: relative; height: 50vh; width: 100%;">
                <canvas id="flowChart"></canvas>
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes blinker {
        50% { opacity: 0; }
    }
    .blink {
        animation: blinker 2s linear infinite;
    }
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const CUSIP = "{{ cusip }}";
    const API_HOST = "{{ api_url }}";
    
    let currentDays = 14; 
    let flowChart = null;
    let isFetching = false;
    let fullDataset = []; 

    document.addEventListener('DOMContentLoaded', () => {
        fetchHistory(currentDays);
        setInterval(updateTodayOnly, 120000); 
    });

    function loadMoreHistory() {
        if (isFetching) return;
        
        const btn = document.getElementById('btn-load-more');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Loading...';
        btn.disabled = true;

        fetchHistory(currentDays + 7)
            .then(() => { currentDays += 7; })
            .catch((err) => { console.error("Load failed", err); })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
    }

    async function fetchHistory(daysToFetch) {
        isFetching = true;
        try {
            const url = `${API_HOST}/api/v1/flow/daily/${CUSIP}?days=${daysToFetch}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error("Failed to fetch history");
            
            const data = await response.json();

            const badge = document.getElementById('identifier-badge');
            if (badge) {
                if (data.ticker && data.cusip) {
                    badge.innerText = `${data.ticker} / ${data.cusip}`;
                } else if (data.cusip) {
                    badge.innerText = `CUSIP: ${data.cusip}`;
                } else {
                    badge.innerText = `CUSIP: ${CUSIP}`;
                }
            }

            fullDataset = data.daily_data || [];

            renderTable(fullDataset);
            renderChart(fullDataset);
        } finally {
            isFetching = false;
        }
    }

    async function updateTodayOnly() {
        try {
            const url = `${API_HOST}/api/v1/flow/daily/${CUSIP}?days=1`;
            const response = await fetch(url);
            if (!response.ok) return;
            
            const data = await response.json();
            const freshRows = data.daily_data || [];
            if (freshRows.length === 0) return;

            freshRows.sort((a, b) => new Date(b.date) - new Date(a.date));
            const latestUpdate = freshRows[0];
            
            const existingIndex = fullDataset.findIndex(d => d.date === latestUpdate.date);
            let dataChanged = false;

            if (existingIndex !== -1) {
                // Update existing row
                if (JSON.stringify(fullDataset[existingIndex]) !== JSON.stringify(latestUpdate)) {
                    fullDataset[existingIndex] = latestUpdate;
                    dataChanged = true;
                }
            } else {
                // Insert new row
                fullDataset.push(latestUpdate);
                dataChanged = true;
            }

            if (dataChanged) {
                renderTable(fullDataset);
                renderChart(fullDataset, existingIndex === -1);
                
                // Flash the specific row
                const rowEl = document.getElementById(`row-${latestUpdate.date}`);
                if (rowEl) flashRow(rowEl);
            }

        } catch (err) {
            console.error("Real-time update failed:", err);
        }
    }

    // --- UI HELPERS ---

    function renderTable(data) {
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';
        
        // Sort: Newest First
        const sorted = [...data].sort((a, b) => new Date(b.date) - new Date(a.date));

        sorted.forEach((row) => {
            const tr = document.createElement('tr');
            tr.id = `row-${row.date}`; 
            tr.innerHTML = generateRowHTML(row); 
            tbody.appendChild(tr);
        });
    }

    function generateRowHTML(row) {
        const netClass = row.net_change > 0 ? 'text-success' : (row.net_change < 0 ? 'text-danger' : 'text-muted');
        
        let netSign = '';
        if (row.net_change > 0) netSign = '+';
        else if (row.net_change < 0) netSign = '-'; 

        // --- FIXED LOGIC START ---
        // Calculate "Today" in New York Time (Market Time)
        const nyDate = new Date().toLocaleString("en-US", {timeZone: "America/New_York"});
        const nyObj = new Date(nyDate);
        const year = nyObj.getFullYear();
        const month = String(nyObj.getMonth() + 1).padStart(2, '0');
        const day = String(nyObj.getDate()).padStart(2, '0');
        const todayNY = `${year}-${month}-${day}`;

        let dateDisplay = row.date;
        
        // Only show badge if the row matches Today's Date in NY
        if (row.date === todayNY) {
            dateDisplay += `
                <span class="badge bg-success bg-opacity-10 text-success border border-success ms-2 blink" style="font-weight: normal; font-size: 0.7em;">
                    <i class="fas fa-circle fa-xs me-1"></i>Live â€¢ Updates 2m
                </span>`;
        }
        // --- FIXED LOGIC END ---

        return `
            <td class="ps-4 fw-bold text-secondary text-nowrap">${dateDisplay}</td>
            <td class="text-end fw-bold ${netClass}">${netSign}${formatNumber(row.net_change)}</td>
            <td class="text-end text-success">+${formatNumber(row.gross_buying)}</td>
            <td class="text-end text-danger pe-4">-${formatNumber(row.gross_selling)}</td>
        `;
    }

    function flashRow(element) {
        element.style.transition = "background-color 0.5s";
        const originalBg = element.style.backgroundColor;
        element.style.backgroundColor = "#e8f5e9";
        setTimeout(() => {
            element.style.backgroundColor = originalBg;
        }, 1000);
    }

    function formatNumber(num) {
        if (num === 0) return "-";
        const abs = Math.abs(num); 
        if (abs >= 1e6) return (abs / 1e6).toFixed(2) + 'M';
        if (abs >= 1e3) return (abs / 1e3).toFixed(1) + 'K';
        return abs.toLocaleString();
    }

    function renderChart(data, isNewDay = false) {
        const chartLoading = document.getElementById('chart-loading');
        if (chartLoading) {
            chartLoading.classList.remove('d-flex');
            chartLoading.classList.add('d-none');
        }

        const ctx = document.getElementById('flowChart').getContext('2d');
        const sorted = [...data].sort((a, b) => new Date(a.date) - new Date(b.date));

        const labels = sorted.map(d => d.date);
        const net = sorted.map(d => d.net_change);
        const buy = sorted.map(d => d.gross_buying);
        const sell = sorted.map(d => -d.gross_selling);

        if (flowChart) {
            flowChart.data.labels = labels;
            flowChart.data.datasets[0].data = net;
            flowChart.data.datasets[1].data = buy;
            flowChart.data.datasets[2].data = sell;
            flowChart.update(isNewDay ? 'default' : 'none'); 
        } else {
            flowChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { 
                            label: 'Net', 
                            data: net, 
                            type: 'line', 
                            borderColor: '#0d6efd', 
                            backgroundColor: '#0d6efd', 
                            tension: 0.3, 
                            pointRadius: 3, 
                            order: 0 
                        },
                        { 
                            label: 'Buy', 
                            data: buy, 
                            backgroundColor: 'rgba(25, 135, 84, 0.7)', 
                            hoverBackgroundColor: 'rgba(25, 135, 84, 1.0)',
                            order: 1 
                        },
                        { 
                            label: 'Sell', 
                            data: sell, 
                            backgroundColor: 'rgba(220, 53, 69, 0.7)', 
                            hoverBackgroundColor: 'rgba(220, 53, 69, 1.0)',
                            order: 2 
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: { grid: { display: false } },
                        y: { ticks: { callback: formatNumber } }
                    }
                }
            });
        }
    }
</script>
{% endblock %}