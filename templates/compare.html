{% extends "base.html" %}

{% block content %}
<h1>Compare 13F Filings</h1>

{% if filing_swapped %}
<div class="alert alert-info alert-dismissible fade show" role="alert">
    <i class="fas fa-info-circle me-2"></i>
    {{ filing_swapped }}
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% endif %}

<form id="compare-form" class="row g-3 mb-4" action="{{ url_for('compare') }}" method="GET">
    <div class="col-md-5">
        <label for="prev" class="form-label">Previous Filing Accession Number</label>
        <input type="text" class="form-control" id="prev" name="prev" value="{{ prev_accession }}" required>
    </div>
    <div class="col-md-5">
        <label for="latest" class="form-label">Latest Filing Accession Number</label>
        <input type="text" class="form-control" id="latest" name="latest" value="{{ latest_accession }}" required>
    </div>
    <div class="col-md-2 d-flex align-items-end">
        <button type="submit" class="btn btn-primary">Compare</button>
    </div>
</form>

{% if comparison %}
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Comparison Summary</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6>Previous Filing</h6>
                <p><strong>Accession:</strong> {{ comparison.metadata.previous_filing.accession_number }}<br>
                    <strong>Filing Date:</strong> {{ comparison.metadata.previous_filing.filing_date }}<br>
                    <strong>Reporting Period:</strong> {{ comparison.metadata.previous_filing.period_of_report }}<br>
                    <strong>Form Type:</strong> {{ comparison.metadata.previous_filing.form_type }}
                </p>
            </div>
            <div class="col-md-6">
                <h6>Latest Filing</h6>
                <p><strong>Accession:</strong> {{ comparison.metadata.latest_filing.accession_number }}<br>
                    <strong>Filing Date:</strong> {{ comparison.metadata.latest_filing.filing_date }}<br>
                    <strong>Reporting Period:</strong> {{ comparison.metadata.latest_filing.period_of_report }}<br>
                    <strong>Form Type:</strong> {{ comparison.metadata.latest_filing.form_type }}
                </p>
            </div>
        </div>

        <div class="row">
            <h3>AI Summary</h3>
            <!-- <p>{{ comparison.metadata.ai_summary }}</p> -->
            <div id="ai-summary-container" class="my-3 p-3 border rounded">Loading AI Summary...</div>
        </div>

        <div class="row mt-3">
            {% for key, value in comparison.metadata.summary.items() %}
            <div class="col-sm-6 col-md-4 col-lg-2 mb-2">
                <div class="card text-center">
                    <div class="card-body">
                        <h5 class="card-title">{{ value }}</h5>
                        <p class="card-text text-muted">{{ key|replace('_', ' ')|title }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- New Holdings Table -->
{% if comparison.holdings.new_holdings %}
<div class="card mb-4">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center"
        data-bs-toggle="collapse" href="#newHoldingsCollapse" role="button" aria-expanded="true"
        aria-controls="newHoldingsCollapse" style="cursor: pointer;">
        <h5 class="mb-0">
            <i class="fas fa-chevron-down me-2"></i>
            New Holdings ({{ comparison.holdings.new_holdings|length }})
        </h5>
        <span class="badge bg-light text-dark">Click to collapse/expand</span>
    </div>
    <div class="collapse show" id="newHoldingsCollapse">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="newHoldingsTable">
                    <thead class="table-light">
                        <tr>
                            <th data-type="string">Issuer Name</th>
                            <th data-type="numeric">Shares (Latest)</th>
                            <th data-type="numeric">Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for holding in comparison.holdings.new_holdings %}
                        <tr>
                            <td>{{ holding.issuer_name_clean }}</td>
                            <td>{{ holding.total_shares_latest | default(0) | format_number }}</td>
                            <td>${{ (holding.total_value_latest) | format_number }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Closed Positions Table -->
{% if comparison.holdings.closed_positions %}
<div class="card mb-4">
    <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center"
        data-bs-toggle="collapse" href="#closedPositionsCollapse" role="button" aria-expanded="true"
        aria-controls="closedPositionsCollapse" style="cursor: pointer;">
        <h5 class="mb-0">
            <i class="fas fa-chevron-down me-2"></i>
            Closed Positions ({{ comparison.holdings.closed_positions|length }})
        </h5>
        <span class="badge bg-light text-dark">Click to collapse/expand</span>
    </div>
    <div class="collapse show" id="closedPositionsCollapse">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="closedPositionsTable">
                    <thead class="table-light">
                        <tr>
                            <th data-type="string">Issuer Name</th>
                            <th data-type="numeric">Shares (Previous)</th>
                            <th data-type="numeric">Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for holding in comparison.holdings.closed_positions %}
                        <tr>
                            <td>{{ holding.issuer_name_clean_prev }}</td>
                            <td>{{ holding.total_shares_prev | default(0) | format_number }}</td>
                            <td>${{ (holding.total_value_prev) | format_number }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Increased Holdings Table -->
{% if comparison.holdings.increased_holdings %}
<div class="card mb-4">
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center"
        data-bs-toggle="collapse" href="#increasedHoldingsCollapse" role="button" aria-expanded="true"
        aria-controls="increasedHoldingsCollapse" style="cursor: pointer;">
        <h5 class="mb-0">
            <i class="fas fa-chevron-down me-2"></i>
            Increased Holdings ({{ comparison.holdings.increased_holdings|length }})
        </h5>
        <span class="badge bg-light text-dark">Click to collapse/expand</span>
    </div>
    <div class="collapse show" id="increasedHoldingsCollapse">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="increasedHoldingsTable">
                    <thead class="table-light">
                        <tr>
                            <th data-type="string">Issuer Name</th>
                            <th data-type="numeric">Previous Shares</th>
                            <th data-type="numeric">Latest Shares</th>
                            <th data-type="numeric">Previous Value</th>
                            <th data-type="numeric">Latest Value</th>
                            <th data-type="numeric">Change (Share)</th>
                            <th data-type="numeric">% Change (Share)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for holding in comparison.holdings.increased_holdings %}
                        <tr>
                            <td>{{ holding.issuer_name_clean }}</td>
                            <td>{{ holding.total_shares_prev | default(0) | format_number }}</td>
                            <td>{{ holding.total_shares_latest | default(0) | format_number }}</td>
                            <td>${{ (holding.total_value_prev | default(0)) | format_number }}</td>
                            <td>${{ (holding.total_value_latest | default(0)) | format_number }}</td>
                            <td class="text-success">+{{ holding.change_in_share | default(0) | format_number }}</td>
                            <td class="text-success">+{{ holding.percent_change | default(0) | safe_round(2) }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Decreased Holdings Table -->
{% if comparison.holdings.decreased_holdings %}
<div class="card mb-4">
    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center"
        data-bs-toggle="collapse" href="#decreasedHoldingsCollapse" role="button" aria-expanded="true"
        aria-controls="decreasedHoldingsCollapse" style="cursor: pointer;">
        <h5 class="mb-0">
            <i class="fas fa-chevron-down me-2"></i>
            Decreased Holdings ({{ comparison.holdings.decreased_holdings|length }})
        </h5>
        <span class="badge bg-light text-dark">Click to collapse/expand</span>
    </div>
    <div class="collapse show" id="decreasedHoldingsCollapse">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="decreasedHoldingsTable">
                    <thead class="table-light">
                        <tr>
                            <th data-type="string">Issuer Name</th>
                            <th data-type="numeric">Previous Shares</th>
                            <th data-type="numeric">Latest Shares</th>
                            <th data-type="numeric">Previous Value</th>
                            <th data-type="numeric">Latest Value</th>
                            <th data-type="numeric">Change</th>
                            <th data-type="numeric">% Change</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for holding in comparison.holdings.decreased_holdings %}
                        <tr>
                            <td>{{ holding.issuer_name_clean }}</td>
                            <td>{{ holding.total_shares_prev | default(0) | format_number }}</td>
                            <td>{{ holding.total_shares_latest | default(0) | format_number }}</td>
                            <td>${{ (holding.total_value_prev | default(0)) | format_number }}</td>
                            <td>${{ (holding.total_value_latest | default(0)) | format_number }}</td>
                            <td class="text-danger">{{ holding.change_in_share | default(0) | format_number }}</td>
                            <td class="text-danger">{{ holding.percent_change | default(0) | round(2) }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Common Holdings Table -->
{% if comparison.holdings.common_holdings %}
<div class="card mb-4">
    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center"
        data-bs-toggle="collapse" href="#commonHoldingsCollapse" role="button" aria-expanded="true"
        aria-controls="commonHoldingsCollapse" style="cursor: pointer;">
        <h5 class="mb-0">
            <i class="fas fa-chevron-down me-2"></i>
            Unchanged Holdings ({{ comparison.holdings.common_holdings|length }})
        </h5>
        <span class="badge bg-light text-dark">Click to collapse/expand</span>
    </div>
    <div class="collapse show" id="commonHoldingsCollapse">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="commonHoldingsTable">
                    <thead class="table-light">
                        <tr>
                            <th data-type="string">Issuer Name</th>
                            <th data-type="numeric">Shares</th>
                            <th data-type="numeric">Value (Previous)</th>
                            <th data-type="numeric">Value (Latest)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for holding in comparison.holdings.common_holdings %}
                        <tr>
                            <td>{{ holding.issuer_name_clean }}</td>
                            <td>{{ holding.total_shares_prev | default(0) | format_number }}</td>
                            <td>${{ (holding.total_value_prev | default(0)) | format_number }}</td>
                            <td {% if holding.total_value_latest> holding.total_value_prev %} class="text-success"
                                {% elif holding.total_value_latest < holding.total_value_prev %} class="text-danger" {%
                                    endif %}>
                                    ${{ (holding.total_value_latest | default(0)) | format_number }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% elif prev_accession and latest_accession %}
<div class="alert alert-warning">
    No comparison data found for the provided accession numbers. Currently, comparison is limited to filings within the
    database. API fetching of filings outside the database is not supported yet.
</div>
{% endif %}
{% endblock %}


{% block scripts %}
<!-- Include DataTables -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script type="text/javascript" charset="utf8"
    src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" charset="utf8"
    src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<!-- Include Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<script>
    const API_HOST = "{{ api_url }}";

    // Utility function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Number formatting function
    function formatNumber(number) {
        if (number === null || number === undefined) return '0';
        return new Intl.NumberFormat().format(number);
    }

    // Custom sorting for formatted numbers
    jQuery.extend(jQuery.fn.dataTable.ext.type.order, {
        "numeric-pre": function (a) {
            a = (a === '-' || a === '') ? 0 : a.replace(/[^\d.-]/g, '');
            return parseFloat(a);
        }
    });

    async function getAiSummary(comparisonData) {
        try {
            console.log(comparisonData.holdings)

            const response = await fetch(`${API_HOST}/api/ai_summary`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    new_holdings: comparisonData.holdings.new_holdings,
                    closed_positions: comparisonData.holdings.closed_positions,
                    increased_holdings: comparisonData.holdings.increased_holdings,
                    decreased_holdings: comparisonData.holdings.decreased_holdings,
                }),
            });

            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }

            const data = await response.json();
            return data.summary;
        } catch (error) {
            console.error("Failed to fetch AI summary:", error);
            return "Failed to generate summary.";
        }
    }

    function displayResults(data) {
        // ... your existing code to create the modal content ...

        // Get the summary and inject it into the modal
        const summaryContainer = document.getElementById('ai-summary-container');
        summaryContainer.innerHTML = 'Loading AI summary...';

        getAiSummary(data)
            .then(summary => {
                summaryContainer.innerHTML = `<p>${escapeHtml(summary)}</p>`;
            })
            .catch(error => {
                summaryContainer.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
            });
    }

    document.addEventListener('DOMContentLoaded', function () {
        const compareForm = document.querySelector('#compare-form');

        if (compareForm) {
            compareForm.addEventListener('submit', async function (event) {
                // Prevent the default form submission immediately
                event.preventDefault();

                const formElement = event.currentTarget;

                const prevAccession = document.getElementById('prev').value;
                const latestAccession = document.getElementById('latest').value;

                // Only proceed if both accession numbers are present
                if (!prevAccession || !latestAccession) {
                    alert("Please enter both accession numbers to compare.");
                    return;
                }

                // Save to database in the background
                try {
                    // Adjust the URL to your Flask or FastAPI server's domain
                    const saveUrl = API_HOST + '/comparisons';

                    // Send a POST request with the data in the JSON body
                    const response = await fetch(saveUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            acc_num_1: prevAccession,
                            acc_num_2: latestAccession,
                        }),
                    });

                    if (response.ok) {
                        console.log("Comparison saved to database successfully.");
                    } else {
                        console.error("Failed to save comparison:", await response.json());
                    }
                } catch (error) {
                    console.error("An error occurred while saving the comparison:", error);
                } finally {
                    // Always submit the form after the fetch call
                    // This reloads the page to display the comparison results
                    if (formElement) {
                        formElement.submit();
                    }
                }
            });
        }
        // Initialize all DataTables
        const tableConfig = {
            pageLength: 25,
            lengthMenu: [10, 25, 50, 100],
            order: [], // No initial sorting
            dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rt<"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
            language: {
                search: "_INPUT_",
                searchPlaceholder: "Search...",
                lengthMenu: "Show _MENU_ entries",
                info: "Showing _START_ to _END_ of _TOTAL_ entries",
                infoEmpty: "Showing 0 to 0 of 0 entries",
                infoFiltered: "(filtered from _MAX_ total entries)",
                paginate: {
                    first: "First",
                    last: "Last",
                    next: "Next",
                    previous: "Previous"
                }
            }
        };

        // Initialize each table if it exists
        $('#newHoldingsTable').DataTable(tableConfig);
        $('#closedPositionsTable').DataTable(tableConfig);
        $('#increasedHoldingsTable').DataTable(tableConfig);
        $('#decreasedHoldingsTable').DataTable(tableConfig);
        $('#commonHoldingsTable').DataTable(tableConfig);

        // Update collapse icons
        $('.collapse').on('show.bs.collapse', function () {
            $(this).prev('.card-header').find('.fa-chevron-down')
                .removeClass('fa-chevron-down')
                .addClass('fa-chevron-up');
        });

        $('.collapse').on('hide.bs.collapse', function () {
            $(this).prev('.card-header').find('.fa-chevron-up')
                .removeClass('fa-chevron-up')
                .addClass('fa-chevron-down');
        });

        // Apply number formatting
        document.querySelectorAll('td').forEach(cell => {
            const text = cell.textContent.trim();
            const num = parseFloat(text.replace(/[^\d.-]/g, ''));
            if (!isNaN(num) && text !== '') {
                cell.textContent = formatNumber(num);
            }
        });

        // Fetch and display AI summary if comparison data exists
        {% if comparison %}
        const comparisonData = {{ comparison| tojson
    }};

    getAiSummary(comparisonData)
        .then(summary => {
            const summaryContainer = document.getElementById('ai-summary-container');
            summaryContainer.innerHTML = `<p>${escapeHtml(summary)}</p>`;
        })
        .catch(error => {
            const summaryContainer = document.getElementById('ai-summary-container');
            summaryContainer.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
        });
    {% endif %}
        });
</script>

<style>
    .table-hover tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.1) !important;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button {
        padding: 0.375rem 0.75rem;
        margin-left: 2px;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        background: #0d6efd;
        color: white !important;
        border: 1px solid #0d6efd;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
        background: #0d6efd;
        color: white !important;
        border: 1px solid #0d6efd;
    }

    .card-header {
        transition: background-color 0.2s ease;
    }

    .card-header:hover {
        background-color: rgba(0, 0, 0, 0.1) !important;
    }
</style>
{% endblock %}