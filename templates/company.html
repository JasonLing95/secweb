{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center">
    <h1>{{ manager.company_name }}</h1>
    <span class="badge bg-primary">CIK: {{ manager.cik }}</span>
</div>

<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title">Company Information</h5>
        <p><strong>Company Name:</strong> {{ manager.company_name or 'N/A' }}</p>
        <p><strong>Phone:</strong> {{ manager.company_phone or 'N/A' }}</p>
        <p><strong>Business Address:</strong> {{ manager.business_address or 'N/A' }}</p>
        <p><strong>Mailing Address:</strong> {{ manager.mailing_address or 'N/A' }}</p>
    </div>
</div>

<h2>Recent Filings</h2>
<div class="table-responsive">
    <table class="table table-striped sortable-table" id="filings-table">
        <thead class="table-dark">
            <tr>
                <th data-sort-by="filing_form_type">Form Type</th>
                <th data-sort-by="accession_number">Accession Number</th>
                <th data-sort-by="filing_date">Filing Date</th>
                <th data-sort-by="period_of_report">Reporting Period</th>
                <th data-sort-by="file_number">File Number</th>
                <th data-sort-by="file_dir">File Directory</th>
                <th data-sort-by="created_at">Created At</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for filing in filings %}
            <tr data-filing-date="{{ filing.filing_date }}" data-accession="{{ filing.accession_number }}"
                data-period-of-report="{{ filing.period_of_report }}">
                <td>{{ filing.form_type }}</td>
                <td><a href="{{ url_for('filing_by_accession', accession_number=filing.accession_number) }}">{{
                        filing.accession_number}}</a></td>
                <td>{{ filing.filing_date }}</td>
                <td>{{ filing.period_of_report }}</td>
                <td>{{ filing.file_number }}</td>
                <td><a href="https://sec.gov/{{ filing.filing_directory }}" target="_blank">{{ filing.filing_directory
                        }}</a>
                </td>
                <td>{{ filing.created_at | human_date }}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary compare-btn"
                        data-accession="{{ filing.accession_number }}">
                        Compare
                    </button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" class="text-center">No filings found for this manager</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const compareButtons = document.querySelectorAll('.compare-btn');
        // const comparisonModal = new bootstrap.Modal(document.getElementById('comparisonModal'));
        // const modalBody = document.getElementById('comparisonModalBody');
        // const exportBtn = document.getElementById('exportComparisonBtn');
        // let currentComparisonData = null;
        const API_HOST = "{{ api_url }}";

        // Store filing dates for proper chronological comparison
        const filingRows = Array.from(document.querySelectorAll('#filings-table tbody tr'));
        const filingDates = filingRows.map(row => ({
            accession: row.dataset.accession,
            date: new Date(row.dataset.filingDate),
            period: row.dataset.periodOfReport, // Add this line
            element: row
        })).sort((a, b) => b.date - a.date); // Sort by date descending (newest first)

        // Find the next filing with a different reporting period
        filingDates.forEach((filing, index) => {
            let previousFilingIndex = index + 1;
            while (previousFilingIndex < filingDates.length && filingDates[previousFilingIndex].period === filing.period) {
                previousFilingIndex++;
            }

            // If a previous filing with a different period is found, update the button's dataset
            const compareBtn = filing.element.querySelector('.compare-btn');
            if (previousFilingIndex < filingDates.length) {
                const previousFiling = filingDates[previousFilingIndex];
                compareBtn.dataset.previousAccession = previousFiling.accession;
                compareBtn.title = `Compare with ${previousFiling.accession} (Reporting Period: ${previousFiling.period})`;
            } else {
                // If no such filing is found, disable the button and add a title
                compareBtn.disabled = true;
                compareBtn.title = "No earlier filing with a different reporting period to compare with";
            }
        });

        // Add event listener to each button to handle the redirect
        compareButtons.forEach(button => {
            if (button.disabled) return;

            button.addEventListener('click', function (event) {
                const latestAccession = this.dataset.accession;
                const previousAccession = this.dataset.previousAccession;

                if (latestAccession && previousAccession) {
                    // Construct the URL and navigate to the new page
                    const url = `{{ url_for('compare', prev='__PREV__', latest='__LATEST__') | safe }}`
                        .replace('__PREV__', previousAccession)
                        .replace('__LATEST__', latestAccession);
                    window.location.href = url;
                } else {
                    alert("Previous filing not found for comparison.");
                }
            });
        });


        /* --- Sorting Script --- */
        function makeTableSortable(table) {
            const headers = table.querySelectorAll('th[data-sort-by]');
            const tbody = table.querySelector('tbody');

            headers.forEach(header => {
                header.addEventListener('click', () => {
                    const sortBy = header.dataset.sortBy;
                    const isAsc = header.classList.contains('asc');

                    // Clear all sorting classes from other headers
                    headers.forEach(h => h.classList.remove('asc', 'desc'));

                    // Toggle sort direction
                    header.classList.add(isAsc ? 'desc' : 'asc');

                    const rows = Array.from(tbody.querySelectorAll('tr'));

                    rows.sort((a, b) => {
                        const aValue = a.querySelector(`[data-sort-by="${sortBy}"]`) ? a.querySelector(`[data-sort-by="${sortBy}"]`).textContent.trim() : a.querySelector(`td:nth-child(${Array.from(header.parentNode.children).indexOf(header) + 1})`).textContent.trim();
                        const bValue = b.querySelector(`[data-sort-by="${sortBy}"]`) ? b.querySelector(`[data-sort-by="${sortBy}"]`).textContent.trim() : b.querySelector(`td:nth-child(${Array.from(header.parentNode.children).indexOf(header) + 1})`).textContent.trim();

                        let comparison = 0;
                        // Handle numeric and date sorting
                        if (!isNaN(Date.parse(aValue)) && !isNaN(Date.parse(bValue))) {
                            comparison = new Date(aValue) - new Date(bValue);
                        } else if (!isNaN(parseFloat(aValue)) && !isNaN(parseFloat(bValue))) {
                            comparison = parseFloat(aValue) - parseFloat(bValue);
                        } else {
                            comparison = aValue.localeCompare(bValue);
                        }

                        return isAsc ? comparison : -comparison;
                    });

                    // Re-append the sorted rows
                    rows.forEach(row => tbody.appendChild(row));
                });
            });
        }

        // Call the function on your table
        const filingsTable = document.getElementById('filings-table');
        if (filingsTable) {
            makeTableSortable(filingsTable);

            // Get the header for the "Reporting Period" column
            const reportingPeriodHeader = document.querySelector('[data-sort-by="period_of_report"]');

            if (reportingPeriodHeader) {
                // Trigger a click to sort by reporting period in descending order
                reportingPeriodHeader.click();
                reportingPeriodHeader.classList.remove('asc');
                reportingPeriodHeader.classList.add('desc');
            }
        }
    });
</script>
{% endblock %}