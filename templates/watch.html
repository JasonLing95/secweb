{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Real-time 13F Filing Updates</h1>
    <button id="toggle-stream" class="btn btn-success">Connected</button>
</div>

<div id="status" class="alert alert-info">
    <div class="d-flex justify-content-between align-items-center">
        <span>Connecting to updates stream...</span>
        <div class="spinner-border spinner-border-sm" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Live Filings Feed</h5>
        <span class="badge bg-light text-dark" id="update-count">0 updates</span>
    </div>
    <div class="card-body p-0">
        <div id="updates-container" style="max-height: 600px; overflow-y: auto;">
            <table class="table table-striped mb-0">
                <thead class="table-dark sticky-top">
                    <tr>
                        <th>Time</th>
                        <th>CIK</th>
                        <th>Company</th>
                        <th>Filing Date</th>
                        <th>Accession Number</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="updates-table">
                    <tr id="no-updates">
                        <td colspan="6" class="text-center py-4 text-muted">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            Waiting for updates...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="mt-3">
    <div class="btn-group">
        <button id="clear-updates" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-trash"></i> Clear All
        </button>
        <button id="pause-updates" class="btn btn-outline-warning btn-sm">
            <i class="bi bi-pause"></i> Pause
        </button>
    </div>
    <span class="ms-3 text-muted small" id="last-update-time"></span>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const statusElement = document.getElementById('status');
        const updatesTable = document.getElementById('updates-table');
        const updateCountElement = document.getElementById('update-count');
        const lastUpdateTimeElement = document.getElementById('last-update-time');
        const toggleStreamBtn = document.getElementById('toggle-stream');
        const clearUpdatesBtn = document.getElementById('clear-updates');
        const pauseUpdatesBtn = document.getElementById('pause-updates');

        let eventSource = null;
        let updateCount = 0;
        let isPaused = false;
        let pausedUpdates = [];
        let processingInitialLoad = true;

        function updateStatus(message, type) {
            // Simplified status message and spinner handling
            const spinner = type === 'info' ? `<div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div>` : '';
            statusElement.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <span>${message}</span>
                    ${spinner}
                </div>
            `;
            statusElement.className = `alert alert-${type}`;
        }

        function addUpdateRow(data, isInitial = false) {
            if (isInitial) {
                const noUpdatesRow = document.getElementById('no-updates');
                if (noUpdatesRow) {
                    noUpdatesRow.remove();
                }
            }
            const row = document.createElement('tr');
            row.className = 'update-row';
            row.innerHTML = `
                <td>${new Date().toLocaleTimeString()}</td>
                <td>
                    <a href="/managers/cik/${data.filing.cik}" class="badge bg-info text-decoration-none" 
                        target="_blank" title="View manager details">
                        ${data.filing.cik}
                    </a>    
                </td>
                <td><strong>${data.filing.company}</strong></td>
                <td>${data.filing.filing_date}</td>
                <td><a href="/filing/accession/${data.filing.accession_no}" class="badge bg-info text-decoration-none" target="_blank" title="View filing details">${data.filing.accession_no}</a></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary copy-btn" data-cik="${data.filing.cik}" title="Copy CIK">
                        <i class="bi bi-clipboard"></i>
                    </button>
                </td>
            `;

            if (isInitial) {
                updatesTable.appendChild(row);
            } else {
                updatesTable.prepend(row);
            }

            // Add click handler for copy button
            row.querySelector('.copy-btn').addEventListener('click', function () {
                const cik = this.getAttribute('data-cik');
                navigator.clipboard.writeText(cik).then(() => {
                    this.innerHTML = '<i class="bi bi-check"></i>';
                    setTimeout(() => {
                        this.innerHTML = '<i class="bi bi-clipboard"></i>';
                    }, 2000);
                });
            });

            // Keep only the last 100 entries
            if (!isInitial) {
                const allRows = updatesTable.querySelectorAll('.update-row');
                if (allRows.length > 100) {
                    updatesTable.removeChild(allRows[allRows.length - 1]);
                }
            }

            if (!isInitial) {
                updateCount++;
                updateCountElement.textContent = `${updateCount} updates`;
                lastUpdateTimeElement.textContent = `Last update: ${new Date().toLocaleTimeString()}`;
            }

            // Add highlight animation
            if (!isInitial) {
                row.style.backgroundColor = '#d4edda';
                setTimeout(() => {
                    row.style.backgroundColor = '';
                }, 1000);
            }
        }

        function connect() {
            updateStatus('Connecting to updates stream...', 'info');

            eventSource = new EventSource("{{ url_for('sse_watch_proxy') }}");

            eventSource.onopen = function () {
                console.log('SSE connection opened successfully');
                updateStatus('Connected to stream', 'success');
                // Initial status is handled by initial_load_start
            };

            eventSource.onmessage = function (event) {
                console.log('Raw SSE message received:', event.data);
                try {
                    let eventData = event.data;
                    if (eventData.startsWith('data: ')) {
                        eventData = eventData.substring(6);
                    }
                    // Ignore keep-alive messages
                    if (eventData.trim() === '') {
                        console.log('Empty SSE message (keep-alive)');
                        return;
                    }

                    const data = JSON.parse(eventData);
                    console.log('SSE data received:', data);

                    if (data.type === 'initial_load_start') {
                        updateStatus(`Loading initial filings... (${data.total_filings} total)`, 'info');
                    } else if (data.type === 'filing') {
                        console.log('Filing data received:', data);
                        console.log('isInitial value:', data.isInitial, 'type:', typeof data.isInitial);

                        const isInitial = data.isInitial == true;
                        if (isPaused) {
                            pausedUpdates.push(data);
                        } else {
                            addUpdateRow(data, isInitial);
                        }
                    } else if (data.type === 'initial_load_complete') {
                        processingInitialLoad = false;
                        updateStatus('Connected. Waiting for new filings...', 'success');
                    } else if (data.type === 'update_complete') {
                        console.log('Update complete received');
                    } else if (data.error) {
                        updateStatus(`Error: ${data.error}`, 'danger');
                    }
                } catch (e) {
                    console.error('Error parsing SSE data:', e, 'Raw data:', event.data);
                }
            };

            eventSource.onerror = function (error) {
                console.error('SSE connection error details:', {
                    readyState: eventSource.readyState,
                    url: eventSource.url,
                    errorType: error.type,
                    error: error
                });

                if (eventSource.readyState === EventSource.CLOSED) {
                    console.log('Connection was closed by the server or client');
                }
                updateStatus('Connection lost. Attempting to reconnect...', 'warning');

                toggleStreamBtn.className = 'btn btn-danger';
                toggleStreamBtn.innerHTML = '<i class="bi bi-x-circle"></i> Disconnected';

                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
                setTimeout(connect, 3000);
            };
        }

        // Toggle connection
        toggleStreamBtn.addEventListener('click', function () {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                updateStatus('Connection stopped', 'secondary');
                this.className = 'btn btn-secondary';
                this.innerHTML = '<i class="bi bi-stop-circle"></i> Stopped';
            } else {
                connect();
            }
        });

        // Clear updates
        clearUpdatesBtn.addEventListener('click', function () {
            updatesTable.innerHTML = '';
            updateCount = 0;
            updateCountElement.textContent = '0 updates';
            lastUpdateTimeElement.textContent = '';
            const noUpdates = document.createElement('tr');
            noUpdates.id = 'no-updates';
            noUpdates.innerHTML = `<td colspan="6" class="text-center py-4 text-muted">No updates yet. Updates will appear here when received.</td>`;
            updatesTable.appendChild(noUpdates);
        });

        // Pause/resume updates
        pauseUpdatesBtn.addEventListener('click', function () {
            isPaused = !isPaused;
            if (isPaused) {
                this.className = 'btn btn-warning';
                this.innerHTML = '<i class="bi bi-play"></i> Resume';
                updateStatus('Updates paused. New filings will be queued.', 'warning');
            } else {
                this.className = 'btn btn-outline-warning';
                this.innerHTML = '<i class="bi bi-pause"></i> Pause';
                updateStatus('Resuming updates...', 'success');
                pausedUpdates.forEach(addUpdateRow);
                pausedUpdates = [];
                setTimeout(() => {
                    updateStatus('Connected. Waiting for new filings...', 'success');
                }, 1000);
            }
        });

        // Add Bootstrap Icons
        if (!document.querySelector('link[href*="bootstrap-icons"]')) {
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css';
            document.head.appendChild(link);
        }

        // Start the connection
        connect();

        window.addEventListener('beforeunload', function () {
            if (eventSource) {
                eventSource.close();
            }
        });
    });
</script>
<style>
    .update-row {
        transition: background-color 0.3s ease;
    }

    .table th {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    #updates-container {
        scrollbar-width: thin;
        scrollbar-color: #6c757d #f8f9fa;
    }

    #updates-container::-webkit-scrollbar {
        width: 8px;
    }

    #updates-container::-webkit-scrollbar-track {
        background: #f8f9fa;
    }

    #updates-container::-webkit-scrollbar-thumb {
        background: #6c757d;
        border-radius: 4px;
    }

    .copy-btn {
        padding: 0.15rem 0.3rem;
        font-size: 0.75rem;
    }
</style>
{% endblock %}